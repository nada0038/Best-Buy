name: CI/CD with Kubernetes Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  KUBE_NAMESPACE: bestbuy

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: product-service
            context: ./product-service-bestbuy
            dockerfile: product-service-bestbuy/Dockerfile
            image: nada0038/product-service-bestbuy
          - name: order-service
            context: ./order-service-bestbuy
            dockerfile: order-service-bestbuy/Dockerfile
            image: nada0038/order-service-bestbuy
          - name: makeline-service
            context: ./makeline-service-bestbuy
            dockerfile: makeline-service-bestbuy/Dockerfile
            image: nada0038/makeline-service-bestbuy
          - name: store-front
            context: ./store-front-bestbuy
            dockerfile: store-front-bestbuy/Dockerfile
            image: nada0038/store-front-bestbuy
          - name: store-admin
            context: ./store-admin-bestbuy
            dockerfile: store-admin-bestbuy/Dockerfile
            image: nada0038/store-admin-bestbuy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Hub credentials
        run: |
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "::error::DOCKER_USERNAME secret is not set in GitHub repository secrets"
            echo "Please go to Settings → Secrets and variables → Actions and add DOCKER_USERNAME"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "::error::DOCKER_PASSWORD secret is not set in GitHub repository secrets"
            echo "Please go to Settings → Secrets and variables → Actions and add DOCKER_PASSWORD"
            exit 1
          fi
          echo "✓ Docker Hub credentials are configured"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ matrix.service.image }}:latest
            ${{ matrix.service.image }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ matrix.service.image }}:buildcache
          cache-to: type=registry,ref=${{ matrix.service.image }}:buildcache,mode=max

  deploy-to-kubernetes:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl with KUBE_CONFIG
        run: |
          if [ -z "${{ secrets.KUBE_CONFIG }}" ]; then
            echo "Error: KUBE_CONFIG secret is not set"
            exit 1
          fi
          
          echo "Decoding KUBE_CONFIG..."
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
          
          if [ ! -s kubeconfig ]; then
            echo "Error: Failed to decode KUBE_CONFIG or file is empty"
            exit 1
          fi
          
          chmod 600 kubeconfig
          echo "Kubeconfig file created successfully"
          echo "Kubeconfig file size: $(wc -c < kubeconfig) bytes"
          
          echo "=== Kubeconfig content (minified) ==="
          kubectl config view --minify --kubeconfig=kubeconfig || true
          
          echo "=== Cluster info ==="
          kubectl cluster-info --kubeconfig=kubeconfig

      - name: Verify Kubernetes connection
        run: |
          echo "=== Testing Kubernetes connection ==="
          kubectl get nodes --kubeconfig=kubeconfig
          kubectl get namespaces --kubeconfig=kubeconfig

      - name: Ensure namespace exists
        run: |
          kubectl apply -f "Deployment Files/01-namespace.yaml" --kubeconfig=kubeconfig

      - name: Deploy Infrastructure Components
        run: |
          kubectl apply -f "Deployment Files/02-mongodb-statefulset.yaml" --kubeconfig=kubeconfig || true
          kubectl apply -f "Deployment Files/03-rabbitmq-deployment.yaml" --kubeconfig=kubeconfig || true
          kubectl apply -f "Deployment Files/04-configmaps.yaml" --kubeconfig=kubeconfig
          kubectl apply -f "Deployment Files/05-secrets.yaml" --kubeconfig=kubeconfig || true

      - name: Deploy Product Service
        run: |
          # Update image tag with commit SHA
          sed -i "s|image: nada0038/product-service-bestbuy:latest|image: nada0038/product-service-bestbuy:${{ github.sha }}|g" "Deployment Files/06-product-service.yaml"
          kubectl apply -f "Deployment Files/06-product-service.yaml" --kubeconfig=kubeconfig
          kubectl rollout status deployment/product-service -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig --timeout=300s || true

      - name: Deploy Order Service
        run: |
          sed -i "s|image: nada0038/order-service-bestbuy:latest|image: nada0038/order-service-bestbuy:${{ github.sha }}|g" "Deployment Files/07-order-service.yaml"
          kubectl apply -f "Deployment Files/07-order-service.yaml" --kubeconfig=kubeconfig
          kubectl rollout status deployment/order-service -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig --timeout=300s || true

      - name: Deploy Makeline Service
        run: |
          sed -i "s|image: nada0038/makeline-service-bestbuy:latest|image: nada0038/makeline-service-bestbuy:${{ github.sha }}|g" "Deployment Files/08-makeline-service.yaml"
          kubectl apply -f "Deployment Files/08-makeline-service.yaml" --kubeconfig=kubeconfig
          kubectl rollout status deployment/makeline-service -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig --timeout=300s || true

      - name: Deploy Store Front
        run: |
          sed -i "s|image: nada0038/store-front-bestbuy:latest|image: nada0038/store-front-bestbuy:${{ github.sha }}|g" "Deployment Files/09-store-front.yaml"
          kubectl apply -f "Deployment Files/09-store-front.yaml" --kubeconfig=kubeconfig
          kubectl rollout status deployment/store-front -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig --timeout=300s || true

      - name: Deploy Store Admin
        run: |
          sed -i "s|image: nada0038/store-admin-bestbuy:latest|image: nada0038/store-admin-bestbuy:${{ github.sha }}|g" "Deployment Files/10-store-admin.yaml"
          kubectl apply -f "Deployment Files/10-store-admin.yaml" --kubeconfig=kubeconfig
          kubectl rollout status deployment/store-admin -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig --timeout=300s || true

      - name: Verify All Deployments
        run: |
          echo "=== Deployments ==="
          kubectl get deployments -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} --kubeconfig=kubeconfig
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -o wide --kubeconfig=kubeconfig

      - name: Cleanup kubeconfig
        if: always()
        run: |
          rm -f kubeconfig

