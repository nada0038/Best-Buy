name: Deploy to Kubernetes (AKS)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, product-service, order-service, makeline-service, store-front, store-admin)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - product-service
          - order-service
          - makeline-service
          - store-front
          - store-admin

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  KUBE_NAMESPACE: bestbuy

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl with KUBE_CONFIG
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl config view
          kubectl get nodes || true

      - name: Verify Kubernetes connection
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl cluster-info
          kubectl get namespaces

      - name: Deploy Infrastructure (if needed)
        if: github.event.inputs.service == 'all' || github.event.inputs.service == ''
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Apply namespace
          kubectl apply -f "Deployment Files/01-namespace.yaml" || true
          
          # Apply MongoDB StatefulSet
          kubectl apply -f "Deployment Files/02-mongodb-statefulset.yaml" || true
          
          # Apply RabbitMQ
          kubectl apply -f "Deployment Files/03-rabbitmq-deployment.yaml" || true
          
          # Apply ConfigMaps
          kubectl apply -f "Deployment Files/04-configmaps.yaml" || true
          
          # Apply Secrets (these should already exist, but we'll try)
          kubectl apply -f "Deployment Files/05-secrets.yaml" || true

      - name: Deploy Product Service
        if: |
          github.event.inputs.service == 'all' || 
          github.event.inputs.service == 'product-service' || 
          (github.event.inputs.service == '' && github.event_name == 'push')
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Update image tag to latest commit SHA
          sed -i "s|image: nada0038/product-service-bestbuy:latest|image: nada0038/product-service-bestbuy:${{ github.sha }}|g" "Deployment Files/06-product-service.yaml" || \
          sed -i "s|image: nada0038/product-service-bestbuy:latest|image: nada0038/product-service-bestbuy:${{ github.sha }}|g" "Deployment Files/06-product-service.yaml"
          
          kubectl apply -f "Deployment Files/06-product-service.yaml"
          kubectl rollout status deployment/product-service -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Deploy Order Service
        if: |
          github.event.inputs.service == 'all' || 
          github.event.inputs.service == 'order-service' || 
          (github.event.inputs.service == '' && github.event_name == 'push')
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Update image tag to latest commit SHA
          sed -i "s|image: nada0038/order-service-bestbuy:latest|image: nada0038/order-service-bestbuy:${{ github.sha }}|g" "Deployment Files/07-order-service.yaml" || \
          sed -i "s|image: nada0038/order-service-bestbuy:latest|image: nada0038/order-service-bestbuy:${{ github.sha }}|g" "Deployment Files/07-order-service.yaml"
          
          kubectl apply -f "Deployment Files/07-order-service.yaml"
          kubectl rollout status deployment/order-service -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Deploy Makeline Service
        if: |
          github.event.inputs.service == 'all' || 
          github.event.inputs.service == 'makeline-service' || 
          (github.event.inputs.service == '' && github.event_name == 'push')
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Update image tag to latest commit SHA
          sed -i "s|image: nada0038/makeline-service-bestbuy:latest|image: nada0038/makeline-service-bestbuy:${{ github.sha }}|g" "Deployment Files/08-makeline-service.yaml" || \
          sed -i "s|image: nada0038/makeline-service-bestbuy:latest|image: nada0038/makeline-service-bestbuy:${{ github.sha }}|g" "Deployment Files/08-makeline-service.yaml"
          
          kubectl apply -f "Deployment Files/08-makeline-service.yaml"
          kubectl rollout status deployment/makeline-service -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Deploy Store Front
        if: |
          github.event.inputs.service == 'all' || 
          github.event.inputs.service == 'store-front' || 
          (github.event.inputs.service == '' && github.event_name == 'push')
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Update image tag to latest commit SHA
          sed -i "s|image: nada0038/store-front-bestbuy:latest|image: nada0038/store-front-bestbuy:${{ github.sha }}|g" "Deployment Files/09-store-front.yaml" || \
          sed -i "s|image: nada0038/store-front-bestbuy:latest|image: nada0038/store-front-bestbuy:${{ github.sha }}|g" "Deployment Files/09-store-front.yaml"
          
          kubectl apply -f "Deployment Files/09-store-front.yaml"
          kubectl rollout status deployment/store-front -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Deploy Store Admin
        if: |
          github.event.inputs.service == 'all' || 
          github.event.inputs.service == 'store-admin' || 
          (github.event.inputs.service == '' && github.event_name == 'push')
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          
          # Update image tag to latest commit SHA
          sed -i "s|image: nada0038/store-admin-bestbuy:latest|image: nada0038/store-admin-bestbuy:${{ github.sha }}|g" "Deployment Files/10-store-admin.yaml" || \
          sed -i "s|image: nada0038/store-admin-bestbuy:latest|image: nada0038/store-admin-bestbuy:${{ github.sha }}|g" "Deployment Files/10-store-admin.yaml"
          
          kubectl apply -f "Deployment Files/10-store-admin.yaml"
          kubectl rollout status deployment/store-admin -n ${{ env.KUBE_NAMESPACE }} --timeout=300s

      - name: Verify Deployments
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl get deployments -n ${{ env.KUBE_NAMESPACE }}
          kubectl get services -n ${{ env.KUBE_NAMESPACE }}
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }}

      - name: Cleanup kubeconfig
        if: always()
        run: |
          rm -f kubeconfig

